@model List<TaskManager.Models.TaskItem>
@using TaskManager.Models;
@{
    ViewData["Title"] = "Danh sách công việc";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var lstProject = ViewBag.ListProject as List<TaskManager.Models.Project>;
    if(lstProject == null)
    {
        lstProject = new List<TaskManager.Models.Project>();
    }
    int idProjectParam = 0;
    int.TryParse(Context.Request.Query["IdProject"], out idProjectParam);
}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">




<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex flex-wrap align-items-center justify-content-between breadcrumb-content">
                    <h5>📋 Danh sách công việc</h5>
                    <div class="d-flex flex-wrap align-items-center">
                        <div class="iq-search-bar device-search mr-3">
                            <form id="Search"class="searchbox">
                                <button type="submit" class="search-link"><i class="ri-search-line"></i></button>

                                <input id="searchtext" maxlength="200" type="text" class="text search-input" placeholder="Tên công việc...">
                            </form>
                        </div>

                        <div class="dropdown dropdown-project mr-3">
                            <div class="dropdown-toggle" id="dropdownMenuButton03" data-toggle="dropdown">
                                <div class="btn bg-body"><span class="h6">Tất cả dự án</span> <i class="ri-arrow-down-s-line ml-2 mr-0"></i></div>
                            </div>
                            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton03">
                                <a class="dropdown-item project-option" href="/Task/Index" data-id="0" data-name="Tất cả dự án">
                                    <i class="bi bi-layers mr-2"></i> Tất cả dự án
                                </a>
                                @foreach (var project in lstProject)
                                {
                                    <a class="dropdown-item project-option" href="/Task/Index?IdProject=@project.Id" data-id="@project.Id" data-name="@project.Name">
                                        <i class="bi bi-folder mr-2"></i>@project.Name
                                    </a>
                                }
                            </div>
                        </div>
                        <a href="#" class="btn btn-primary" data-target="#new-task-modal" data-toggle="modal"> <i class="bi bi-plus-circle"></i> Thêm công việc</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    @if (Model != null && Model.Count > 0)
                    {
                        foreach (var task in Model)
                        {
                            <div class="col-lg-12">
                                <div class="card card-widget task-card">
                                    <div class="card-body">
                                        <div class="d-flex flex-wrap align-items-center justify-content-between">
                                            <div class="d-flex align-items-center">
                                                <div>
                                                    @{
                                                        string icon = "🆕";

                                                        if (task.Status == 1)
                                                        {
                                                            icon = "⚙️";
                                                        }
                                                        else if (task.Status == 2)
                                                        {
                                                            icon = "✅";
                                                        }
                                                    }

                                                    <h5 class="mb-2">
                                                        @icon @task.Title

                                                    </h5>

                                                </div>
                                            </div>
                                            <div class="media align-items-center mt-md-0 mt-3">
                                               
                                                <a title="Xem chi tiết" class="btn bg-primary-light mr-3" data-toggle="collapse" href="#collapseEdit1-@task.Id" role="button" aria-expanded="false" aria-controls="collapseEdit1-@task.Id">🔍</a>

                                                <a title="Cập nhật trạng thái" onclick="openEditModal('@task.Id')" class="btn bg-success-light mr-3">
                                                    <i class="bi bi-pencil-square"></i>
                                                </a>
                                                <a href="#" onclick="event.stopPropagation(); confirmDelete('@task.Id')" class="btn bg-secondary-light" data-bs-toggle="tooltip" title="Xóa">
                                                    <i class="bi bi-trash"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="collapse" id="collapseEdit1-@task.Id">
                                    <div class="card card-list task-card">
                                        <div class="card-header d-flex align-items-center justify-content-between px-0 mx-3">
                                            <div class="header-title">
                                                <label class="control-label h5" for="customCheck05"> <i class="bi bi-card-checklist mr-2"></i>Chi tiết công việc</label>

                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="card mb-3">
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-lg-12">
                                                            <div class="form-group mb-0">
                                                                <label for="ProjectId-@task.Id" class="h5">Dự án</label>
                                                                <select name="ProjectId-@task.Id" class="selectpicker form-control" data-style="py-0" disabled>
                                                                    @{
                                                                        foreach (var project in lstProject)
                                                                        {
                                                                            <option value="@project.Id">@project.Name</option>
                                                                        }
                                                                    }

                                                                </select>
                                                            </div>
                                                        </div>

                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card mb-3">
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-lg-6">
                                                            <label for="Priority-@task.Id" class="h5">Độ ưu tiên</label>
                                                            <div class="dropdown bootstrap-select form-control">
                                                                <select id="Priority-@task.Id" name="Priority-@task.Id" class="selectpicker form-control" data-style="py-0" disabled>
                                                                    @if(task.Priority == (int)CommonEnums.TaskPriority.Low)
                                                                    {
                                                                        <option value="@CommonEnums.TaskPriority.Low">@CommonEnums.GetDescription(CommonEnums.TaskPriority.Low)</option>
                                                                    }else if(task.Priority == 2)
                                                                    {
                                                                        <option value="@CommonEnums.TaskPriority.High">@CommonEnums.GetDescription(CommonEnums.TaskPriority.High)</option>
                                                                    }
                                                                    else
                                                                    {
                                                                        <option value="@CommonEnums.TaskPriority.Medium">@CommonEnums.GetDescription(CommonEnums.TaskPriority.Medium)</option>
                                                                    }                                                                                                                           
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-6">
                                                            <div class="form-group mb-0">
                                                                <label for="DueDate-@task.Id" class="h5">Hạn chót</label>
                                                                <input disabled type="date" class="form-control" id="DueDate-@task.Id"
                                                                value="@(task.DueDate.HasValue ? task.DueDate.Value.ToString("yyyy-MM-dd") : "")" />

                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card mb-3">
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-lg-4">
                                                            <label for="Status-@task.Id" class="h5">Trạng thái</label>
                                                            <div class="dropdown bootstrap-select form-control">
                                                                <select id="Status-@task.Id" name="Status-@task.Id" class="selectpicker form-control" data-style="py-0" disabled>
                                                                    @if (task.Status == (int)CommonEnums.TaskStatus.InProgress)
                                                                    {
                                                                        <option value="@CommonEnums.TaskStatus.InProgress">@CommonEnums.GetDescription(CommonEnums.TaskStatus.InProgress)</option>
                                                                    }
                                                                    else if (task.Status == (int)CommonEnums.TaskStatus.Completed)
                                                                    {
                                                                        <option value="@CommonEnums.TaskStatus.Completed">@CommonEnums.GetDescription(CommonEnums.TaskStatus.Completed)</option>
                                                                    }
                                                                    else
                                                                    {
                                                                        <option value="@CommonEnums.TaskStatus.New" selected>@CommonEnums.GetDescription(CommonEnums.TaskStatus.New)</option>
                                                                    }
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-4">
                                                            <div class="form-group mb-0">
                                                                <label for="CreatedAt-@task.Id" class="h5">Ngày tạo</label>
                                                                <input disabled type="date" class="form-control" id="CreatedAt-@task.Id"
                                                                value="@(task.CreatedAt.HasValue ? task.CreatedAt.Value.ToString("yyyy-MM-dd") : "")" />
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-4">
                                                            <div class="form-group mb-0">
                                                                <label for="UpdatedAt-@task.Id" class="h5">Ngày cập nhật</label>
                                                                <input disabled type="date" class="form-control" id="UpdatedAt-@task.Id"
                                                                value="@(task.UpdatedAt.HasValue ? task.UpdatedAt.Value.ToString("yyyy-MM-dd") : "")" />
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="card mb-3">
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-lg-12">
                                                            <h5 class="mb-2">Mô tả</h5>
                                                            <p class="mb-0">@task.Description</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card mb-3">
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-lg-12">
                                                            <h5 class="mb-2">Ghi chú</h5>
                                                            <p class="mb-0">@task.Notes</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            @*    <div class="card mb-3">
                                                <div class="card-body">
                                                    <div class="row">                                                       
                                                        <div class="col-lg-12">
                                                            <label for="exampleInputText01" class="h5">Attachments</label>
                                                            <div class="custom-file">
                                                                <input type="file" class="custom-file-input" id="inputGroupFile001">
                                                                <label class="custom-file-label" for="inputGroupFile001">Upload media</label>
                                                            </div>
                                                        </div>

                                                    </div>
                                                </div>
                                            </div>    *@                                
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="col-lg-12">
                            <H3 class="text-center text-muted"><i class="ri-information-line mr-2"></i> Không tìm thấy công việc</H3>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade bd-example-modal-lg" role="dialog" aria-modal="true" id="new-task-modal">
    <div class="modal-dialog  modal-dialog-centered modal-lg" role="document">
        <form id="createTaskForm">
            <div class="modal-content">
                <div class="modal-header d-block text-center pb-3 border-bttom">
                    <h3 class="modal-title" id="addTaskModalLabel">📝 Thêm công việc mới</h3>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="form-group mb-3">
                                <label for="Title" class="h5">Tiêu đề*</label>
                                <input type="text" class="form-control" id="Title" name="Title" placeholder="Nhập tiêu đề" maxlength="255" required
                                oninvalid="this.setCustomValidity('Vui lòng nhập tiêu đề')"
                                oninput="this.setCustomValidity('')">
                            </div>
                        </div>
                        <div class="col-lg-12">
                            <div class="form-group mb-3">
                                <label for="ProjectId" class="h5">Dự án*</label>
                                <div class="dropdown bootstrap-select form-control">
                                    <select id="ProjectId" name="ProjectId" class="selectpicker form-control" data-style="py-0">
                                        @foreach (var project in lstProject)
                                        {
                                            if (project.Id == idProjectParam)
                                            {
                                                <option value="@project.Id" selected>@project.Name</option>
                                            }
                                            else
                                            {
                                                <option value="@project.Id">@project.Name</option>
                                            }
                                         
                                        }
                                </select>
                            </div>
                        </div>
                    </div>
                        <div class="col-lg-6">
                            <label for="Priority" class="h5">Độ ưu tiên</label>
                            <div class="dropdown bootstrap-select form-control">
                                <select id="Priority" name="Priority" class="selectpicker form-control" data-style="py-0">
                                    @foreach (var priority in Enum.GetValues(typeof(CommonEnums.TaskPriority)).Cast<CommonEnums.TaskPriority>())
                                    {
                                        <option value="@((int)priority)" @(priority == CommonEnums.TaskPriority.Medium ? "selected" : "")>
                                            @CommonEnums.GetDescription(priority)
                                        </option>
                                    }
                                </select>

                            </div>
                        </div>
                    <div class="col-lg-6">
                        <div class="form-group mb-3">
                                <label for="DueDate" class="h5">Hạn chót*</label>
                                <input type="date" class="form-control" id="DueDate" name="DueDate" value="">
                        </div>
                    </div>
                    <div class="col-lg-12">
                        <div class="form-group mb-3">
                                <label for="Description" class="h5">Mô tả</label>
                                <textarea class="form-control" id="Description" name="Description" rows="2" placeholder="Nhập mô tả"></textarea>
                        </div>
                    </div>
                        <div class="col-lg-12">
                            <div class="form-group mb-3">
                                <label for="Notes" class="h5">Ghi chú</label>
                                <textarea class="form-control" id="Notes" name="Notes" rows="2" placeholder="Nhập ghi chú"></textarea>
                            </div>
                        </div>
                    <div class="col-lg-12">
                        <div class="d-flex flex-wrap align-items-ceter justify-content-center mt-4">
                           <button type="submit" class="btn btn-primary mr-3">Lưu</button>
                                <div class="btn btn-secondary" data-dismiss="modal">Huỷ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </form>
    </div>
</div>




<div class="modal fade bd-example-modal-lg" role="dialog" aria-modal="true" id="edit-task-modal">
    <div class="modal-dialog  modal-dialog-centered modal-lg" role="document">
        <form id="editTaskForm">
            <div class="modal-content">
                <div class="modal-header d-block text-center pb-3 border-bttom">
                    <h3 class="modal-title" id="editTaskModalLabel">✏️ Cập nhật trạng thái</h3>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <input type="hidden" id="editId" name="Id" />
                        <div class="col-lg-12">
                            <label for="editStatus" class="h5">Trạng thái</label>
                            <div class="dropdown bootstrap-select form-control">
                                <select id="editStatus" name="Status" class="selectpicker form-control" data-style="py-0">                               
                                        <option value="1" selected>Đang xử lý</option>                                 
                                        <option value="2">Hoàn thành</option>
                                        <option value="0">Tạo mới</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-lg-12">
                            <div class="form-group mb-3">
                                <label for="editNotes" class="h5">Ghi chú*</label>
                                <textarea class="form-control" id="editNotes" name="Notes" rows="2" placeholder="Nhập ghi chú cập nhật"></textarea>
                            </div>
                        </div>

                        <div class="col-lg-12">
                            <div class="d-flex flex-wrap align-items-ceter justify-content-center mt-4">
                                <button type="submit" class="btn btn-primary mr-3">Lưu</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>



@section Scripts {
    <script>
        $(document).ready(function () {
            $('[data-bs-toggle="tooltip"]').tooltip();

            $('#createTaskForm').submit(function (e) {
                e.preventDefault();

                var title = $('#Title').val().trim();
                var projectId = $('#ProjectId').val();
                var dueDate = $('#DueDate').val();

  
                if (!title) {
                    Swal.fire('Thiếu thông tin', 'Vui lòng nhập tiêu đề.', 'warning');
                    return;
                }

                if (!projectId) {
                    Swal.fire('Thiếu thông tin', 'Vui lòng chọn dự án.', 'warning');
                    return;
                }

                if (!dueDate) {
                    Swal.fire('Thiếu thông tin', 'Vui lòng chọn hạn chót.', 'warning');
                    return;
                }


                var data = $(this).serialize();

                $.post('/Task/Create', data, function (res) {
                    if (res.success) {
                        Swal.fire('Thành công!', 'Đã thêm công việc.', 'success')
                            .then(() => location.reload());
                    } else {
                        Swal.fire('Lỗi', res.error || 'Không thể thêm', 'error');
                    }
                });
            });


         
            $('#editTaskForm').submit(function (e) {
                e.preventDefault();
                var notes = $('#editNotes').val().trim();
                var status = $('#editStatus').val();
                if (!notes) {
                    Swal.fire('Thiếu thông tin', 'Vui lòng ghi chú cập nhật.', 'warning');
                    return;
                }
                if(!status)
                {
                     $('#editStatus').val(1);
                }

                var data = $(this).serialize();


                $.post('/Task/Edit', data, function (res) {
                    if (res.success) {
                        Swal.fire('Đã cập nhật!', '', 'success').then(() => location.reload());
                    } else {
                        Swal.fire('Lỗi', res.error || 'Không thể cập nhật', 'error');
                    }
                });
            });
        });

        function openEditModal(id) {
            $.ajax({
                url: '/Task/GetTaskById?id=' + id,
                type: 'GET',
                success: function (res) {
                    if (res.success) {
                        const task = res.data;
                        $('#editId').val(task.id);
                        $('#editStatus').val(task.Status);
                        $('#editNotes').val(task.Notes);
                        $('#edit-task-modal').modal('show');
                    } else {
                        Swal.fire('Lỗi', res.error || 'Không thể lấy dữ liệu.', 'error');
                    }
                },
                error: function () {
                    Swal.fire('Lỗi', 'Không thể kết nối đến máy chủ.', 'error');
                }
            });
        }

        function confirmDelete(TaskId) {
            Swal.fire({
                title: 'Bạn có chắc muốn xóa?',
                text: "Hành động này không thể hoàn tác!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/Task/DeleteTask',
                        type: 'POST',
                        data: { id: TaskId },
                        success: function (res) {
                            if (res.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Đã xóa công việc!',
                                    timer: 1000,
                                    showConfirmButton: false
                                }).then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire('Lỗi', res.error || 'Không thể xóa.', 'error');
                            }
                        },
                        error: function () {
                            Swal.fire('Lỗi', 'Không thể kết nối server.', 'error');
                        }
                    });
                }
            });
        }

        $(document).ready(function () {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('IdProject');
            const searchText = urlParams.get('textsearch');
            $('#searchtext').val(searchText);

            if (projectId) {
                const projectName = getProjectNameById(projectId);
                $('#dropdownMenuButton03 .h6').text(projectName);
              
            }
            else {
                $('#dropdownMenuButton03 .h6').text("Tất cả dự án");

            }
        });

        function getProjectNameById(projectId) {
            let projectName = "Tất cả dự án";  
            $('.project-option').each(function () {
                if ($(this).data('id') == projectId) {
                    projectName = $(this).data('name');
                }
            });
            return projectName;
        }

    </script>
    <script>
        $(document).ready(function () {
            $('#Search').on('submit', function (e) {
                e.preventDefault(); 

                const text = $('.search-input').val().trim();
                const params = new URLSearchParams(window.location.search);

                if (text) {
                    params.set('textsearch', text);
                } else {
                    params.delete('textsearch');
                }

                const projectId = params.get('IdProject');
                let newUrl = '/Task/Index?' + params.toString();

                window.location.href = newUrl;
            });
        });
    </script>

}
